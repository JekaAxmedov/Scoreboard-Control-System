<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ó–∞—Å—Ç–∞–≤–∫–∞</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Arial', sans-serif;
      overflow: hidden;
    }

    #splash {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(45deg, #000000, #00001a, #00002b);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      opacity: 1;
      transition: opacity 1s ease-out;
    }

    #videoWrapper {
      position: relative;
      width: 85%;
      max-width: 1000px;
      aspect-ratio: 16/9;
    }

    /* –ê–º–±–∏–ª–∞–π—Ç –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –æ—Ç –≤–∏–¥–µ–æ */
    .ambilight-glow {
      position: absolute;
      top: -100px;
      left: -100px;
      right: -100px;
      bottom: -100px;
      border-radius: 40px;
      filter: blur(80px) brightness(1.2);
      opacity: 1;
      transition: all 0.1s ease;
      z-index: 0;
      transform-origin: center;
      pointer-events: none;
    }

    .ambilight-glow::before {
      content: '';
      position: absolute;
      top: -50px;
      left: -50px;
      right: -50px;
      bottom: -50px;
      border-radius: 35px;
      filter: blur(60px);
      opacity: 0.8;
      transition: all 0.1s ease;
      transform-origin: center;
    }

    .ambilight-glow::after {
      content: '';
      position: absolute;
      top: -20px;
      left: -20px;
      right: -20px;
      bottom: -20px;
      border-radius: 30px;
      filter: blur(40px);
      opacity: 0.6;
      transition: all 0.1s ease;
      transform-origin: center;
    }

    /* –ü—É–ª—å—Å–∞—Ü–∏—è –ø—Ä–∏ –±–∞—Å–∞—Ö */
    .bass-pulse {
      animation: bassPulse 0.15s ease-out;
    }

    @keyframes bassPulse {
      0% { 
        transform: scale(1); 
        filter: blur(80px) brightness(1.2);
      }
      50% { 
        transform: scale(1.15); 
        filter: blur(95px) brightness(1.7);
      }
      100% { 
        transform: scale(1); 
        filter: blur(80px) brightness(1.2);
      }
    }

    #videoContainer {
      position: relative;
      width: 100%;
      height: 100%;
      border-radius: 25px;
      overflow: hidden;
      background: #000;
      backdrop-filter: blur(10px);
      box-shadow: 
        0 25px 50px rgba(0, 0, 0, 0.9),
        inset 0 0 0 2px rgba(255, 255, 255, 0.1);
      z-index: 2;
    }

    #introVideo {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 25px;
      transition: opacity 0.3s ease-out;
    }

    /* –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    .nav-button {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 60px;
      height: 60px;
      border-radius: 50%;
      border: none;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 15;
      opacity: 0;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
      user-select: none;
    }

    .nav-button:hover {
      background: rgba(255, 255, 255, 0.9);
      color: #000;
      transform: translateY(-50%) scale(1.1);
      box-shadow: 0 12px 35px rgba(0, 0, 0, 0.6);
    }

    .nav-button:active {
      transform: translateY(-50%) scale(0.95);
    }

    .nav-button.show {
      opacity: 0.8;
    }

    .nav-button.show:hover {
      opacity: 1;
    }

    #prevBtn {
      left: -80px;
    }

    #nextBtn {
      right: -80px;
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ */
    .video-indicator {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 8px;
      z-index: 15;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    .video-indicator.show {
      opacity: 0.8;
    }

    .indicator-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.4);
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .indicator-dot.active {
      background: white;
      transform: scale(1.3);
      box-shadow: 0 0 10px rgba(255, 255, 255, 0.6);
    }

    .indicator-dot:hover {
      background: rgba(255, 255, 255, 0.7);
      transform: scale(1.1);
    }

    #loadingOverlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      color: white;
      font-size: 18px;
      z-index: 20;
      transition: opacity 0.5s ease-out;
      border-radius: 25px;
    }

    .spinner {
      width: 50px;
      height: 50px;
      border: 3px solid rgba(255, 255, 255, 0.3);
      border-top: 3px solid #fff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-bottom: 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #continueBtn {
      position: absolute;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      padding: 15px 35px;
      font-size: 18px;
      font-weight: 600;
      color: white;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      border-radius: 50px;
      cursor: pointer;
      opacity: 0;
      transition: all 0.3s ease;
      box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      backdrop-filter: blur(10px);
      z-index: 3;
    }

    #continueBtn:hover {
      transform: translateX(-50%) translateY(15px) scale(1.05);
      box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
    }

    #continueBtn:active {
      transform: translateX(-50%) translateY(18px) scale(0.98);
    }

    #continueBtn.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .error-message {
      color: #ff6b6b;
      text-align: center;
      padding: 20px;
      font-size: 16px;
    }

    .fallback-content {
      display: none;
      text-align: center;
      color: white;
      padding: 40px;
    }

    .fallback-content h1 {
      font-size: 3em;
      margin-bottom: 20px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .fallback-content p {
      font-size: 1.2em;
      opacity: 0.8;
      margin-bottom: 30px;
    }

    #volumeSlider {
      position: absolute;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%);
      width: 220px;
      height: 8px;
      -webkit-appearance: none;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border-radius: 50px;
      outline: none;
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
      cursor: pointer;
      z-index: 3;
    }

    /* –ü–æ–ª–∑—É–Ω–æ–∫ (–±–µ–≥—É–Ω–æ–∫) */
    #volumeSlider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #764ba2;
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.6);
      cursor: pointer;
      transition: transform 0.2s;
    }

    #volumeSlider::-webkit-slider-thumb:hover {
      transform: scale(1.2);
    }

    /* –î–ª—è Firefox */
    #volumeSlider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid #764ba2;
      box-shadow: 0 4px 10px rgba(102, 126, 234, 0.6);
      cursor: pointer;
      transition: transform 0.2s;
    }

    #volumeSlider::-moz-range-thumb:hover {
      transform: scale(1.2);
    }

    /* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –±–∞—Å–æ–≤ */
    #bassIndicator {
      position: absolute;
      bottom: 140px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.7);
      font-size: 12px;
      z-index: 3;
      display: none;
    }

    .bass-active {
      color: #ff6ec4 !important;
      text-shadow: 0 0 10px #ff6ec4;
    }

    @media (max-width: 768px) {
      #videoWrapper {
        width: 95%;
      }
      
      .nav-button {
        width: 50px;
        height: 50px;
        font-size: 22px;
      }
      
      #prevBtn {
        left: -65px;
      }

      #nextBtn {
        right: -65px;
      }
      
      .ambilight-glow {
        top: -50px;
        left: -50px;
        right: -50px;
        bottom: -50px;
        border-radius: 35px;
        filter: blur(50px) brightness(1.2);
      }
      
      .ambilight-glow::before {
        top: -30px;
        left: -30px;
        right: -30px;
        bottom: -30px;
        filter: blur(40px);
      }
      
      .ambilight-glow::after {
        top: -10px;
        left: -10px;
        right: -10px;
        bottom: -10px;
        filter: blur(20px);
      }
      
      #videoContainer {
        border-radius: 20px;
      }
      
      #introVideo {
        border-radius: 20px;
      }
      
      #loadingOverlay {
        border-radius: 20px;
      }
      
      #continueBtn {
        bottom: 20px;
        padding: 12px 25px;
        font-size: 16px;
      }
      
      .fallback-content h1 {
        font-size: 2em;
      }
    }

    @media (max-width: 480px) {
      #prevBtn {
        left: -20px;
        top: 30%;
      }

      #nextBtn {
        right: -20px;
        top: 30%;
      }

      .nav-button {
        width: 40px;
        height: 40px;
        font-size: 18px;
        background: rgba(0, 0, 0, 0.8);
      }
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–æ—è–≤–ª–µ–Ω–∏—è */
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    #videoWrapper {
      animation: fadeIn 1.2s ease-out;
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è */
    .fade-out {
      opacity: 0 !important;
      transform: scale(1.1);
    }

    /* –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∏–¥–µ–æ */
    .video-fade-out {
      opacity: 0;
    }
  </style>
</head>
<body>

  <div id="splash">
    <div id="videoWrapper">
      <canvas id="hiddenCanvas" style="display: none;"></canvas>
      <div class="ambilight-glow" id="ambilightGlow"></div>
      <div id="videoContainer">
        <video id="introVideo" playsinline preload="auto" crossorigin="anonymous"></video>
        
        <!-- –ù–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ -->
        <button class="nav-button" id="prevBtn" title="–ü—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–∏–¥–µ–æ">‚Äπ</button>
        <button class="nav-button" id="nextBtn" title="–°–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ">‚Ä∫</button>
        
        <!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ -->
        <div class="video-indicator" id="videoIndicator"></div>
        
        <div id="loadingOverlay">
          <div class="spinner"></div>
          <div>–ó–∞–≥—Ä—É–∑–∫–∞ –≤–∏–¥–µ–æ...</div>
        </div>
      </div>
    </div>

    <div class="fallback-content">
      <h1>–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h1>
      <p>–ì–æ—Ç–æ–≤—ã –Ω–∞—á–∞—Ç—å –ø—É—Ç–µ—à–µ—Å—Ç–≤–∏–µ?</p>
    </div>

    <button id="continueBtn">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
    <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="0.2">
    <div id="bassIndicator">üéµ Bass Detection</div>
  </div>

  <script>
    const video = document.getElementById('introVideo');
    const btn = document.getElementById('continueBtn');
    const splash = document.getElementById('splash');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const fallbackContent = document.querySelector('.fallback-content');
    const videoContainer = document.getElementById('videoContainer');
    const volumeSlider = document.getElementById('volumeSlider');
    const hiddenCanvas = document.getElementById('hiddenCanvas');
    const ambilightGlow = document.getElementById('ambilightGlow');
    const bassIndicator = document.getElementById('bassIndicator');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const videoIndicator = document.getElementById('videoIndicator');

    const ctx = hiddenCanvas.getContext('2d', {
        willReadFrequently: true
    });

    const videoSources = [
        "video/intro1.mp4",
        "video/intro2.mp4", 
        "video/intro3.mp4",
        "video/intro4.mp4"
    ];

    let currentVideoIndex = Math.floor(Math.random() * videoSources.length);
    let videoLoaded = false;
    let canPlay = false;
    let isAnalyzing = false;
    let audioContext = null;
    let analyser = null;
    let dataArray = null;
    let source = null;
    let bassDetectionActive = false;
    let isTransitioning = false;

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ –≤–∏–¥–µ–æ
    function initVideoIndicators() {
      videoSources.forEach((_, index) => {
        const dot = document.createElement('div');
        dot.className = 'indicator-dot';
        if (index === currentVideoIndex) {
          dot.classList.add('active');
        }
        dot.addEventListener('click', () => switchToVideo(index));
        videoIndicator.appendChild(dot);
      });
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞
    function updateVideoIndicator() {
      const dots = videoIndicator.querySelectorAll('.indicator-dot');
      dots.forEach((dot, index) => {
        dot.classList.toggle('active', index === currentVideoIndex);
      });
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –Ω–∞–≤–∏–≥–∞—Ü–∏–æ–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
    function showNavigation() {
      setTimeout(() => {
        prevBtn.classList.add('show');
        nextBtn.classList.add('show');
        videoIndicator.classList.add('show');
      }, 1000);
    }

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ –≤–∏–¥–µ–æ
    function switchToVideo(index) {
      if (isTransitioning || index === currentVideoIndex) return;
      
      isTransitioning = true;
      const wasPlaying = !video.paused;
      const currentVolume = video.volume;
      
      // –ü–ª–∞–≤–Ω–æ–µ –∑–∞—Ç—É—Ö–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–≥–æ –≤–∏–¥–µ–æ
      video.classList.add('video-fade-out');
      
      setTimeout(() => {
        currentVideoIndex = index;
        video.src = videoSources[currentVideoIndex];
        updateVideoIndicator();
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –∑–∞–≥—Ä—É–∑–∫—É
        loadingOverlay.style.display = 'flex';
        loadingOverlay.style.opacity = '1';
        
        // –ö–æ–≥–¥–∞ –Ω–æ–≤–æ–µ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∑–∏—Ç—Å—è
        const handleNewVideoLoad = () => {
          video.classList.remove('video-fade-out');
          loadingOverlay.style.opacity = '0';
          setTimeout(() => {
            loadingOverlay.style.display = 'none';
          }, 500);
          
          video.volume = currentVolume;
          if (wasPlaying) {
            const playPromise = video.play();
            if (playPromise !== undefined) {
              playPromise.catch(console.warn);
            }
          }
          
          isTransitioning = false;
          video.removeEventListener('loadeddata', handleNewVideoLoad);
        };
        
        video.addEventListener('loadeddata', handleNewVideoLoad);
      }, 300);
    }

    // –ü—Ä–µ–¥—ã–¥—É—â–µ–µ –≤–∏–¥–µ–æ
    function previousVideo() {
      const prevIndex = (currentVideoIndex - 1 + videoSources.length) % videoSources.length;
      switchToVideo(prevIndex);
    }

    // –°–ª–µ–¥—É—é—â–µ–µ –≤–∏–¥–µ–æ  
    function nextVideo() {
      const nextIndex = (currentVideoIndex + 1) % videoSources.length;
      switchToVideo(nextIndex);
    }

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏
    prevBtn.addEventListener('click', previousVideo);
    nextBtn.addEventListener('click', nextVideo);

    // –ö–ª–∞–≤–∏–∞—Ç—É—Ä–Ω–∞—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è
    document.addEventListener('keydown', (e) => {
      if (e.key === 'ArrowLeft') {
        previousVideo();
      } else if (e.key === 'ArrowRight') {
        nextVideo();
      }
    });

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –∫–Ω–æ–ø–∫–∏
    function showContinueButton() {
      setTimeout(() => {
        btn.classList.add('show');
        showNavigation();
      }, 3000);
    }

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
    initVideoIndicators();
    video.src = videoSources[currentVideoIndex];
    video.volume = 0.1;

    // –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –ø–æ–ª–∑—É–Ω–∫–∞
    volumeSlider.addEventListener('input', () => {
      video.volume = volumeSlider.value;
    });

    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Web Audio API –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ –±–∞—Å–æ–≤
    function initAudioAnalysis() {
      try {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        source = audioContext.createMediaElementSource(video);
        
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        
        analyser.fftSize = 256;
        const bufferLength = analyser.frequencyBinCount;
        dataArray = new Uint8Array(bufferLength);
        
        bassDetectionActive = true;
        bassIndicator.style.display = 'block';
        
        console.log('–ê—É–¥–∏–æ–∞–Ω–∞–ª–∏–∑ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω');
      } catch (error) {
        console.log('Web Audio API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
        bassDetectionActive = false;
      }
    }

    // –ê–Ω–∞–ª–∏–∑ –±–∞—Å–æ–≤
    function analyzeBass() {
      if (!bassDetectionActive || !analyser) return 0;
      
      analyser.getByteFrequencyData(dataArray);
      
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –Ω–∏–∑–∫–∏–µ —á–∞—Å—Ç–æ—Ç—ã (–±–∞—Å—ã) - –ø–µ—Ä–≤—ã–µ 15% —Å–ø–µ–∫—Ç—Ä–∞
      let bassSum = 0;
      const bassRange = Math.floor(dataArray.length * 0.15);
      
      for (let i = 0; i < bassRange; i++) {
        bassSum += dataArray[i];
      }
      
      const bassAverage = bassSum / bassRange;
      return bassAverage / 255; // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –¥–æ 0-1
    }

    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ –∏–∑ –≤–∏–¥–µ–æ
    function getVideoColors() {
      if (!video.videoWidth || !video.videoHeight) return null;

      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä canvas
      const scale = 0.1; // –£–º–µ–Ω—å—à–∞–µ–º –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
      hiddenCanvas.width = video.videoWidth * scale;
      hiddenCanvas.height = video.videoHeight * scale;
      
      // –†–∏—Å—É–µ–º –∫–∞–¥—Ä –≤–∏–¥–µ–æ
      ctx.drawImage(video, 0, 0, hiddenCanvas.width, hiddenCanvas.height);
      
      const imageData = ctx.getImageData(0, 0, hiddenCanvas.width, hiddenCanvas.height);
      const data = imageData.data;
      
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º —Ü–≤–µ—Ç–∞ –ø–æ –∫—Ä–∞—è–º –¥–ª—è –∞–º–±–∏–ª–∞–π—Ç —ç—Ñ—Ñ–µ–∫—Ç–∞
      const colors = {
        top: [0, 0, 0],
        bottom: [0, 0, 0],
        left: [0, 0, 0],
        right: [0, 0, 0],
        center: [0, 0, 0]
      };
      
      const width = hiddenCanvas.width;
      const height = hiddenCanvas.height;
      
      // –°–æ–±–∏—Ä–∞–µ–º —Ü–≤–µ—Ç–∞ –ø–æ –∫—Ä–∞—è–º
      const edgePixels = {
        top: [],
        bottom: [],
        left: [],
        right: [],
        center: []
      };
      
      // –í–µ—Ä—Ö–Ω–∏–π –∏ –Ω–∏–∂–Ω–∏–π –∫—Ä–∞–π
      for (let x = 0; x < width; x += 2) {
        const topIndex = x * 4;
        const bottomIndex = ((height - 1) * width + x) * 4;
        
        if (data[topIndex + 3] > 0) {
          edgePixels.top.push([data[topIndex], data[topIndex + 1], data[topIndex + 2]]);
        }
        if (data[bottomIndex + 3] > 0) {
          edgePixels.bottom.push([data[bottomIndex], data[bottomIndex + 1], data[bottomIndex + 2]]);
        }
      }
      
      // –õ–µ–≤—ã–π –∏ –ø—Ä–∞–≤—ã–π –∫—Ä–∞–π
      for (let y = 0; y < height; y += 2) {
        const leftIndex = y * width * 4;
        const rightIndex = (y * width + width - 1) * 4;
        
        if (data[leftIndex + 3] > 0) {
          edgePixels.left.push([data[leftIndex], data[leftIndex + 1], data[leftIndex + 2]]);
        }
        if (data[rightIndex + 3] > 0) {
          edgePixels.right.push([data[rightIndex], data[rightIndex + 1], data[rightIndex + 2]]);
        }
      }
      
      // –¶–µ–Ω—Ç—Ä –¥–ª—è –æ–±—â–µ–≥–æ —Ç–æ–Ω–∞
      const centerX = Math.floor(width / 2);
      const centerY = Math.floor(height / 2);
      const centerRadius = Math.min(width, height) * 0.2;
      
      for (let x = centerX - centerRadius; x < centerX + centerRadius; x += 3) {
        for (let y = centerY - centerRadius; y < centerY + centerRadius; y += 3) {
          if (x >= 0 && x < width && y >= 0 && y < height) {
            const index = (y * width + x) * 4;
            if (data[index + 3] > 0) {
              edgePixels.center.push([data[index], data[index + 1], data[index + 2]]);
            }
          }
        }
      }
      
      // –í—ã—á–∏—Å–ª—è–µ–º —Å—Ä–µ–¥–Ω–∏–µ —Ü–≤–µ—Ç–∞
      Object.keys(edgePixels).forEach(edge => {
        if (edgePixels[edge].length > 0) {
          let r = 0, g = 0, b = 0;
          edgePixels[edge].forEach(pixel => {
            r += pixel[0];
            g += pixel[1];
            b += pixel[2];
          });
          
          colors[edge] = [
            Math.round(r / edgePixels[edge].length),
            Math.round(g / edgePixels[edge].length),
            Math.round(b / edgePixels[edge].length)
          ];
        }
      });
      
      return colors;
    }

    // –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –∞–º–±–∏–ª–∞–π—Ç –∞–Ω–∞–ª–∏–∑–∞
    function updateAmbilight() {
      if (!video.videoWidth || video.paused || video.ended) return;
      
      const colors = getVideoColors();
      if (!colors) return;
      
      // –ê–Ω–∞–ª–∏–∑–∏—Ä—É–µ–º –±–∞—Å—ã
      const bassLevel = analyzeBass();
      const isBassPeak = bassLevel > 0.4;
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –±–∞—Å–æ–≤
      if (isBassPeak) {
        bassIndicator.classList.add('bass-active');
        bassIndicator.textContent = `üéµ Bass: ${Math.round(bassLevel * 100)}%`;
      } else {
        bassIndicator.classList.remove('bass-active');
        bassIndicator.textContent = 'üéµ Bass Detection';
      }
      
      // –°–æ–∑–¥–∞–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ü–≤–µ—Ç–æ–≤ –≤–∏–¥–µ–æ
      const centerColor = colors.center;
      const topColor = colors.top;
      const bottomColor = colors.bottom;
      const leftColor = colors.left;
      const rightColor = colors.right;
      
      // –£—Å–∏–ª–∏–≤–∞–µ–º –Ω–∞—Å—ã—â–µ–Ω–Ω–æ—Å—Ç—å, –∏—Å–ø–æ–ª—å–∑—É—è –±–æ–ª–µ–µ –∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–µ –∫–æ—ç—Ñ—Ñ–∏—Ü–∏–µ–Ω—Ç—ã
      const saturation = 1.8 + (bassLevel * 1.0);
      const brightness = 1.0 + (bassLevel * 0.5);
      
      const enhanceColor = (color) => {
        return [
          Math.min(255, Math.round(color[0] * saturation * brightness)),
          Math.min(255, Math.round(color[1] * saturation * brightness)),
          Math.min(255, Math.round(color[2] * saturation * brightness))
        ];
      };
      
      const enhancedCenter = enhanceColor(centerColor);
      const enhancedTop = enhanceColor(topColor);
      const enhancedBottom = enhanceColor(bottomColor);
      const enhancedLeft = enhanceColor(leftColor);
      const enhancedRight = enhanceColor(rightColor);
      
      // –°–æ–∑–¥–∞–µ–º —Å–ª–æ–∂–Ω—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç
      const centerRgba = `rgba(${enhancedCenter[0]}, ${enhancedCenter[1]}, ${enhancedCenter[2]}, 0.9)`;
      const topRgba = `rgba(${enhancedTop[0]}, ${enhancedTop[1]}, ${enhancedTop[2]}, 0.7)`;
      const bottomRgba = `rgba(${enhancedBottom[0]}, ${enhancedBottom[1]}, ${enhancedBottom[2]}, 0.7)`;
      const leftRgba = `rgba(${enhancedLeft[0]}, ${enhancedLeft[1]}, ${enhancedLeft[2]}, 0.7)`;
      const rightRgba = `rgba(${enhancedRight[0]}, ${enhancedRight[1]}, ${enhancedRight[2]}, 0.7)`;
      
      // –ü—Ä–∏–º–µ–Ω—è–µ–º –≥—Ä–∞–¥–∏–µ–Ω—Ç —Å —É—á–µ—Ç–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–π
      const gradient = `radial-gradient(ellipse at center, ${centerRgba} 0%, ${topRgba} 25%, ${rightRgba} 50%, ${bottomRgba} 75%, ${leftRgba} 100%)`;
      
      ambilightGlow.style.background = gradient;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø—É–ª—å—Å–∞—Ü–∏—é –ø—Ä–∏ –±–∞—Å–∞—Ö
      if (isBassPeak) {
        ambilightGlow.classList.remove('bass-pulse');
        void ambilightGlow.offsetWidth; // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π reflow
        ambilightGlow.classList.add('bass-pulse');
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Å–µ–≤–¥–æ-—ç–ª–µ–º–µ–Ω—Ç—ã —Å –±–æ–ª—å—à–∏–º —ç—Ñ—Ñ–µ–∫—Ç–æ–º
      const style = document.createElement('style');
      style.textContent = `
        .ambilight-glow::before {
          background: 
            radial-gradient(ellipse 200% 200% at 30% 30%, ${topRgba} 0%, transparent 60%),
            radial-gradient(ellipse 200% 200% at 70% 30%, ${rightRgba} 0%, transparent 60%),
            radial-gradient(ellipse 200% 200% at 70% 70%, ${bottomRgba} 0%, transparent 60%),
            radial-gradient(ellipse 200% 200% at 30% 70%, ${leftRgba} 0%, transparent 60%) !important;
        }
        .ambilight-glow::after {
          background: 
            radial-gradient(ellipse 300% 300% at center, ${centerRgba} 0%, transparent 50%),
            conic-gradient(from 0deg at center, ${topRgba} 0deg, ${rightRgba} 90deg, ${bottomRgba} 180deg, ${leftRgba} 270deg, ${topRgba} 360deg) !important;
        }
      `;
      
      const oldStyle = document.querySelector('#ambilight-style');
      if (oldStyle) oldStyle.remove();
      style.id = 'ambilight-style';
      document.head.appendChild(style);
    }

    // –ó–∞–ø—É—Å–∫ –∞–º–±–∏–ª–∞–π—Ç –∞–Ω–∞–ª–∏–∑–∞
    function startAmbilight() {
      if (isAnalyzing) return;
      isAnalyzing = true;
      
      // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∞—É–¥–∏–æ–∞–Ω–∞–ª–∏–∑ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–∏
      if (!audioContext) {
        initAudioAnalysis();
      }
      
      function animate() {
        if (!video.paused && !video.ended && videoLoaded) {
          updateAmbilight();
        }
        requestAnimationFrame(animate);
      }
      animate();
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ
    video.addEventListener('loadeddata', () => {
      videoLoaded = true;
      loadingOverlay.style.opacity = '0';
      setTimeout(() => {
        loadingOverlay.style.display = 'none';
      }, 500);
      
      const playPromise = video.play();
      if (playPromise !== undefined) {
        playPromise
          .then(() => {
            canPlay = true;
            video.volume = 0.1;
            startAmbilight();
            showContinueButton();
          })
          .catch((error) => {
            console.log('–ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', error);
            showVideoControls();
          });
      }
    });

    // –ï—Å–ª–∏ –≤–∏–¥–µ–æ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å
    video.addEventListener('error', (e) => {
      console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤–∏–¥–µ–æ:', e);
      showFallback();
    });

    // –¢–∞–π–º–∞—É—Ç –Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ –≤–∏–¥–µ–æ –¥–æ–ª–≥–æ –≥—Ä—É–∑–∏—Ç—Å—è
    setTimeout(() => {
      if (!videoLoaded) {
        showFallback();
      }
    }, 10000);

    // –ü–æ–∫–∞–∑–∞—Ç—å fallback –∫–æ–Ω—Ç–µ–Ω—Ç
    function showFallback() {
      videoContainer.style.display = 'none';
      fallbackContent.style.display = 'block';
      showContinueButton();
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –∫–æ–Ω—Ç—Ä–æ–ª—ã –¥–ª—è —Ä—É—á–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞
    function showVideoControls() {
      // –ï—Å–ª–∏ –∫–Ω–æ–ø–∫–∞ —É–∂–µ –µ—Å—Ç—å ‚Äî –Ω–µ —Å–æ–∑–¥–∞—ë–º –∑–∞–Ω–æ–≤–æ
      if (videoContainer.querySelector('.play-button-fallback')) return;

      video.controls = true; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã –Ω–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π
      video.muted = false;
      video.volume = 0.1;

      const playButton = document.createElement('button');
      playButton.innerHTML = '‚ñ∂ –í–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ —Å–æ –∑–≤—É–∫–æ–º';
      playButton.className = 'play-button-fallback'; // –î–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è
      playButton.style.cssText = `
          position: absolute;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%);
          padding: 15px 30px;
          font-size: 18px;
          background: rgba(0, 0, 0, 0.8);
          color: white;
          border: 2px solid white;
          border-radius: 25px;
          cursor: pointer;
          z-index: 5;
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      `;

      playButton.addEventListener('click', async (e) => {
          e.stopPropagation(); // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–ø–ª—ã—Ç–∏–µ, —á—Ç–æ–±—ã –Ω–µ –≤—ã–∑–≤–∞—Ç—å –æ–±—â–∏–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ —Å–Ω–æ–≤–∞

          // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º AudioContext
          if (audioContext && audioContext.state === 'suspended') {
            await audioContext.resume().catch(console.warn);
          }

          // –ü—Ä–æ–±—É–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏
          const playPromise = video.play();
          if (playPromise) {
            playPromise
                .then(() => {
                playButton.remove();
                video.controls = false; // –£–±–∏—Ä–∞–µ–º –Ω–∞—Ç–∏–≤–Ω—ã–µ –∫–æ–Ω—Ç—Ä–æ–ª—ã
                canPlay = true;
                if (!isAnalyzing) startAmbilight();
                showContinueButton(); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å"
                })
                .catch((error) => {
                console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ—Å—Ç–∏ –≤–∏–¥–µ–æ:', error);
                alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–∫–ª—é—á–∏—Ç–µ –∑–≤—É–∫ –≤—Ä—É—á–Ω—É—é –∏ –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –µ—â—ë —Ä–∞–∑');
                });
          }
      });

      videoContainer.appendChild(playButton);
    }

    // –ü–µ—Ä–µ—Ö–æ–¥ –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    btn.addEventListener('click', () => {
      splash.classList.add('fade-out');
      
      setTimeout(() => {
        window.location.href = 'main.html';
      }, 1000);
    });

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–∏—è –∑–≤—É–∫–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞—Ö
    document.addEventListener('click', async function(event) {
      // 1. –í—Å–µ–≥–¥–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º AudioContext, –µ—Å–ª–∏ –æ–Ω —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
      if (audioContext && audioContext.state === 'suspended') {
          try {
            await audioContext.resume();
            console.log('‚úÖ AudioContext —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω');
          } catch (e) {
            console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å AudioContext:', e);
          }
      }

      // 2. –ï—Å–ª–∏ –≤–∏–¥–µ–æ –∑–∞–≥—Ä—É–∂–µ–Ω–æ, –Ω–æ –µ—â—ë –Ω–µ –∏–≥—Ä–∞–µ—Ç ‚Äî –ø—Ä–æ–±—É–µ–º –∑–∞–ø—É—Å—Ç–∏—Ç—å
      if (videoLoaded && video.paused) {
          video.muted = false;
          video.volume = 0.1;
          
          const playPromise = video.play();
          if (playPromise !== undefined) {
            playPromise
                .then(() => {
                console.log('‚úÖ –í–∏–¥–µ–æ –∑–∞–ø—É—â–µ–Ω–æ —Å–æ –∑–≤—É–∫–æ–º');
                canPlay = true;
                if (!isAnalyzing) startAmbilight(); // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–º–±–∏–ª–∞–π—Ç, –µ—Å–ª–∏ –µ—â—ë –Ω–µ –∑–∞–ø—É—â–µ–Ω
                })
                .catch((error) => {
                console.warn('‚ùå –ê–≤—Ç–æ–≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ:', error);
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∫–∞–∫ fallback
                showVideoControls();
                });
          }
      } 
      // 3. –ï—Å–ª–∏ –≤–∏–¥–µ–æ —É–∂–µ –∏–≥—Ä–∞–µ—Ç, –Ω–æ –∑–≤—É–∫ –æ—Ç–∫–ª—é—á–µ–Ω ‚Äî –≤–∫–ª—é—á–∞–µ–º –∑–≤—É–∫
      else if (video.muted && !video.paused) {
          video.muted = false;
          video.volume = 0.1;
          console.log('üîä –ó–≤—É–∫ –≤–∫–ª—é—á—ë–Ω');
      }
    });
  </script>

</body>
</html>