<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>JA Football Scoreboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
            position: relative;
        }

        #backgroundImage {
            position: absolute;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            object-fit: cover;
            z-index: 1;
            transition: opacity 0.5s ease;
            opacity: 1;
        }

        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2;
        }

        .scoreboard {
            position: relative;
            z-index: 3;
            width: 100%;
            height: 100vh;
        }

        /* Перемещаемые элементы */
        .draggable {
            position: absolute;
            user-select: none;
            cursor: grab;
            text-shadow: 2px 2px 8px rgba(0, 0, 0, 0.9);
            transition: transform 0.1s;
            padding: 5px;
            border-radius: 8px;
        }

        .draggable:active {
            cursor: grabbing;
        }
    </style>
</head>
<body>
    <!-- Фон -->
    <img id="backgroundImage" src="" alt="Фон" style="display: none;">

    <!-- Затемнение -->
    <div class="overlay"></div>

    <!-- Табло -->
    <div class="scoreboard">
        <div id="team1Score" class="draggable">0</div>
        <div id="team2Score" class="draggable">0</div>
        <div id="timerDisplay" class="draggable">00:00</div>
        <div id="halfIndicator" class="draggable" style="font-size: 1.5em; opacity: 0.9;"></div>
    </div>

    <script>
        const ws = new WebSocket(`ws://${window.location.host}`);
        let isDragging = false;
        let draggedEl = null;
        let startX, startY, startLeft, startTop;
        let state = {}; // Будет заполнено при получении full_state

        // Для динамических шрифтов
        const loadedFonts = new Set();

        function createFontFace(font) {
            if (loadedFonts.has(font.fontFamily)) return;
            loadedFonts.add(font.fontFamily);

            const style = document.createElement('style');
            style.textContent = `
                @font-face {
                    font-family: '${font.fontFamily}';
                    src: url('${font.path}') format('${getFormat(font.file)}');
                    font-display: swap;
                }
            `;
            document.head.appendChild(style);
        }

        function getFormat(filename) {
            const ext = filename.toLowerCase();
            if (ext.endsWith('.woff2')) return 'woff2';
            if (ext.endsWith('.woff')) return 'woff';
            if (ext.endsWith('.ttf')) return 'truetype';
            if (ext.endsWith('.otf')) return 'opentype';
            return 'truetype';
        }

        function applyPosition(id, x, y) {
            const el = document.getElementById(id);
            if (el) {
                el.style.left = x + 'px';
                el.style.top = y + 'px';
            }
        }

        function applyFontSize(id, size) {
            const el = document.getElementById(id);
            if (el) el.style.fontSize = size + 'em';
        }

        function applyFontFamily(id, family) {
            const el = document.getElementById(id);
            if (el) el.style.fontFamily = family;
        }

        function updateTimer(time) {
            const mins = Math.floor(time / 60);
            const secs = time % 60;
            document.getElementById('timerDisplay').textContent = 
                `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function updateHalf(half) {
            document.getElementById('halfIndicator').textContent = half === 1 ? '1 тайм' : '2 тайм';
        }

        function updateUI(newState) {
            if (!newState) {
                console.error('Получено пустое состояние');
                return;
            }
            state = newState;

            // Защита от undefined
            document.getElementById('team1Score').textContent = newState.team1Score ?? 0;
            document.getElementById('team2Score').textContent = newState.team2Score ?? 0;
            updateTimer(newState.time ?? 0);
            updateHalf(newState.currentHalf ?? 1);

            // Позиции
            if (newState.positions) {
                if (newState.positions.timer) {
                    applyPosition('timerDisplay', newState.positions.timer.x, newState.positions.timer.y);
                }
                if (newState.positions.team1Score) {
                    applyPosition('team1Score', newState.positions.team1Score.x, newState.positions.team1Score.y);
                }
                if (newState.positions.team2Score) {
                    applyPosition('team2Score', newState.positions.team2Score.x, newState.positions.team2Score.y);
                }
            }

            // Шрифты
            if (newState.fontSettings) {
                const fs = newState.fontSettings;
                if (fs.teamScore) {
                    applyFontSize('team1Score', fs.teamScore.fontSize ?? 4);
                    applyFontSize('team2Score', fs.teamScore.fontSize ?? 4);
                    applyFontFamily('team1Score', fs.teamScore.fontFamily ?? 'Arial');
                    applyFontFamily('team2Score', fs.teamScore.fontFamily ?? 'Arial');
                }
                if (fs.timer) {
                    applyFontSize('timerDisplay', fs.timer.fontSize ?? 6);
                    applyFontFamily('timerDisplay', fs.timer.fontFamily ?? 'Arial');
                    applyFontFamily('halfIndicator', fs.timer.fontFamily ?? 'Arial');
                }
            }

            // Фон
            if (newState.background?.image) {
                const bg = document.getElementById('backgroundImage');
                bg.src = newState.background.image;
                bg.style.display = 'block';
                const scale = newState.background.scale || 1.0;
                const pos = newState.background.position || { x: 0, y: 0 };
                bg.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`;
            }
        }

        // Перетаскивание
        function startDrag(e, el) {
            isDragging = true;
            draggedEl = el;
            startX = e.clientX || e.touches[0].clientX;
            startY = e.clientY || e.touches[0].clientY;
            startLeft = parseInt(el.style.left) || 0;
            startTop = parseInt(el.style.top) || 0;
            el.style.cursor = 'grabbing';
            e.preventDefault();
        }

        function drag(e) {
            if (!isDragging || !draggedEl) return;
            const x = e.clientX || e.touches[0].clientX;
            const y = e.clientY || e.touches[0].clientY;
            const dx = x - startX;
            const dy = y - startY;
            draggedEl.style.left = (startLeft + dx) + 'px';
            draggedEl.style.top = (startTop + dy) + 'px';
            e.preventDefault();
        }

        function stopDrag() {
            if (isDragging && draggedEl) {
                const x = parseInt(draggedEl.style.left) || 0;
                const y = parseInt(draggedEl.style.top) || 0;
                let element = draggedEl.id;
                // Преобразуем ID в ключи состояния
                if (element === 'timerDisplay') element = 'timer';
                if (element === 'team1Score') element = 'team1Score';
                if (element === 'team2Score') element = 'team2Score';

                ws.send(JSON.stringify({
                    command: 'update_element_position',
                    element: element,
                    position: { x, y }
                }));

                draggedEl.style.cursor = 'grab';
                isDragging = false;
                draggedEl = null;
            }
        }

        // Инициализация
        window.addEventListener('load', () => {
            document.querySelectorAll('.draggable').forEach(el => {
                el.style.cursor = 'grab';
                el.addEventListener('mousedown', (e) => startDrag(e, el));
                el.addEventListener('touchstart', (e) => startDrag(e, el), { passive: false });
            });

            document.addEventListener('mousemove', drag);
            document.addEventListener('touchmove', drag, { passive: false });
            document.addEventListener('mouseup', stopDrag);
            document.addEventListener('touchend', stopDrag);
        });

        // WebSocket
        ws.onopen = () => console.log('Подключено');
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);

            switch (data.type) {
                case 'full_state':
                    updateUI(data.state);
                    break;
                case 'score_update':
                    document.getElementById('team1Score').textContent = data.team1;
                    document.getElementById('team2Score').textContent = data.team2;
                    break;
                case 'time_update':
                    updateTimer(data.time);
                    break;
                case 'half_changed':
                    updateHalf(data.half);
                    break;
                case 'element_position_update':
                    const elementMap = {
                        'timer': 'timerDisplay',
                        'team1Score': 'team1Score',
                        'team2Score': 'team2Score'
                    };
                    const targetId = elementMap[data.element] || data.element;
                    applyPosition(targetId, data.position.x, data.position.y);
                    break;
                case 'font_size_update':
                    if (data.element === 'teamScore') {
                        applyFontSize('team1Score', data.size);
                        applyFontSize('team2Score', data.size);
                    } else if (data.element === 'timer') {
                        applyFontSize('timerDisplay', data.size);
                    }
                    break;
                case 'font_family_update':
                    if (data.element === 'teamScore') {
                        applyFontFamily('team1Score', data.fontFamily);
                        applyFontFamily('team2Score', data.fontFamily);
                    } else if (data.element === 'timer') {
                        applyFontFamily('timerDisplay', data.fontFamily);
                        applyFontFamily('halfIndicator', data.fontFamily);
                    }
                    break;
                case 'available_fonts':
                    data.fonts.forEach(font => createFontFace(font));
                    break;
                case 'background_update':
                    if (data.background.image) {
                        const bg = document.getElementById('backgroundImage');
                        bg.src = data.background.image;
                        bg.style.display = 'block';
                        const scale = data.background.scale || 1.0;
                        const pos = data.background.position || { x: 0, y: 0 };
                        bg.style.transform = `translate(${pos.x}px, ${pos.y}px) scale(${scale})`; 
                    }
                    break;
                case 'background_position_update':
                    console.log('Получена позиция фона:', data.position);
                    const bgPosition = document.getElementById('backgroundImage');
                        if (bgPosition && bgPosition.style.display !== 'none') {
                            const x = data.position.x || 0;
                            const y = data.position.y || 0;
                            let scale = 1.0;
                            const transform = bgPosition.style.transform;
                            const scaleMatch = transform.match(/scale\(([^)]+)\)/);
                            if (scaleMatch) {
                                scale = parseFloat(scaleMatch[1]) || 1.0;
                            }
                            bgPosition.style.transform = `translate(${x}px, ${y}px) scale(${scale})`;
                        }
                    break;
                case 'background_size_update':
                    const bgSize = document.getElementById('backgroundImage');
                    if (bgSize && bgSize.style.display !== 'none') {
                        const newScale = data.scale || 1.0;
                        // Сохраняем текущую позицию, чтобы не сбрасывать
                        let x = 0, y = 0;
                        const transform = bgSize.style.transform;
                        const translateMatch = transform.match(/translate\(([^,]+)px,\s*([^)]+)px\)/);
                        if (translateMatch) {
                            x = parseFloat(translateMatch[1]) || 0;
                            y = parseFloat(translateMatch[2]) || 0;
                        }
                        bgSize.style.transform = `translate(${x}px, ${y}px) scale(${newScale})`;
                        console.log('Масштаб фона обновлён:', newScale);
                    }
                    break;
                default:
                    console.warn('Неизвестный тип сообщения:', data.type);
            }
        };
    </script>
</body>
</html>